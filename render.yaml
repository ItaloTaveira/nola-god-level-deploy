# Render infra-as-code for three separate resources: managed Postgres, backend
# web service (Node) and frontend static site. Replace placeholders in the
# Render Console or via secrets before deploying.

databases:
  - type: postgres
    name: nola-postgres
    plan: free
    region: oregon
    # Optional: initial database name (Render will create a DB and credentials)
    databaseName: nola_postgres

services:
  - type: web
    name: nola-backend
    env: node
    # Build and run from the `backend` folder
    repo: ItaloTaveira/nola-god-level-deploy
    branch: main
    root: backend
    buildCommand: npm ci
    startCommand: npm start
    autoDeploy: true
    healthCheckPath: /api/v1/health
    envVars:
      - key: DATABASE_URL
        # Set this to the External DB URL from the managed Postgres above
        value: "<REPLACE_WITH_DATABASE_URL>"
      - key: HEALTH_FAIL_ON_DB
        value: "false"

  - type: static
    name: nola-frontend
    repo: ItaloTaveira/nola-god-level-deploy
    branch: main
    root: frontend
    buildCommand: npm ci && npm run build
    publishPath: dist
    autoDeploy: true
    envVars:
      - key: VITE_API_URL
        # Point the SPA to your backend URL (or leave empty to use relative paths)
        value: "https://<RENDER_BACKEND_URL>"

jobs:
  - type: job
    name: db-connection-test
    command: sh -lc 'export DATABASE_URL="$JOB_DATABASE_URL" && node tools/test_db_connection.js'
    envVars:
      - key: JOB_DATABASE_URL
        value: "<REPLACE_WITH_DATABASE_URL>"

  - type: job
    name: data-generator
    command: python generate_data.py --db-url "$JOB_DATABASE_URL"
    envVars:
      - key: JOB_DATABASE_URL
        value: "<REPLACE_WITH_DATABASE_URL>"
# Notes:
# - After creating the Postgres instance in Render, copy the External DB URL
#   (it will look like: postgres://USER:PASSWORD@HOST:5432/DBNAME?sslmode=require)
#   and paste it into the `DATABASE_URL` and `JOB_DATABASE_URL` values above
#   (or set them as Secrets in the Render Console rather than editing this file).
# - For the frontend, prefer leaving `VITE_API_URL` empty and call APIs with
#   relative paths (e.g. `/api`). If you need an absolute URL, set `VITE_API_URL`
#   to the backend service URL (https://...).
# - If you change the Backend to a Docker build instead of `env: node`, adjust
#   the `services.nola-backend` block to `env: docker` and set `dockerfilePath`.
